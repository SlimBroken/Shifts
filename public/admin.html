if (serverConnected) {
                const dataToSync = {
                    shiftSubmissions: workerSubmissions,
                    approvedWorkers: JSON.parse(localStorage.getItem('approvedWorkers') || '[]'),
                    preferencesLocked: newLockState,
                    lockTimestamp: localStorage.getItem('lockTimestamp'),
                    lastUpdate: Date.now()
                };
                syncToGitHub(dataToSync);
            }
            
            if (newLockState) {
                showAlert('ğŸ”’ Preferences locked! Workers can no longer submit or modify their preferences.', 'warning');
            } else {
                showAlert('ğŸ”“ Preferences unlocked! Workers can now submit and modify their preferences.', 'success');
            }
        }

        function updateLockStatus() {
            const isLocked = localStorage.getItem('preferencesLocked') === 'true';
            const lockTimestamp = localStorage.getItem('lockTimestamp');
            const lockStatusDiv = document.getElementById('lockStatus');
            const toggleBtn = document.getElementById('toggleLockBtn');
            
            if (isLocked) {
                const lockTime = lockTimestamp ? new Date(parseInt(lockTimestamp)).toLocaleString() : 'Unknown';
                lockStatusDiv.className = 'lock-status locked';
                lockStatusDiv.innerHTML = `
                    <strong>ğŸ”’ PREFERENCES LOCKED</strong><br>
                    <small>Locked since: ${lockTime}</small><br>
                    <small>Workers cannot submit or modify preferences while locked.</small>
                `;
                toggleBtn.textContent = 'ğŸ”“ Unlock Preferences';
                toggleBtn.className = 'btn btn-success';
            } else {
                lockStatusDiv.className = 'lock-status unlocked';
                lockStatusDiv.innerHTML = `
                    <strong>ğŸ”“ PREFERENCES UNLOCKED</strong><br>
                    <small>Workers can submit and modify their preferences.</small>
                `;
                toggleBtn.textContent = 'ğŸ”’ Lock Preferences';
                toggleBtn.className = 'btn btn-warning';
            }
        }

        function displayApprovedWorkers() {
            const container = document.getElementById('approvedWorkersList');
            const approvedWorkers = JSON.parse(localStorage.getItem('approvedWorkers') || '[]');
            
            if (approvedWorkers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning" style="background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;">
                        <strong>âš ï¸ No approved workers!</strong><br>
                        Workers cannot access the system until you add their names to the approved list.<br>
                        <small>Add worker names above to allow them to submit shift preferences.</small>
                    </div>
                `;
                return;
            }

            let html = '<h4>Approved Workers (' + approvedWorkers.length + '):</h4>';
            html += '<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">';
            
            approvedWorkers.forEach(workerName => {
                html += `
                    <div style="background: white; padding: 10px 15px; border-radius: 5px; border: 1px solid #dee2e6; display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 500;">${workerName}</span>
                        <button onclick="removeWorker('${workerName.replace(/'/g, "\\'")}')" 
                                style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                            âœ•
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 5px; font-size: 12px; color: #155724;">';
            html += '<strong>âœ… Access Control Active:</strong> Only these workers can submit shift preferences. Workers must enter their exact name (case-insensitive) to access the system.';
            html += '</div>';

            container.innerHTML = html;
        }

        function addWorker() {
            const newWorkerName = document.getElementById('newWorkerName').value.trim();
            
            if (!newWorkerName) {
                showAlert('Please enter a worker name.', 'warning');
                return;
            }

            const approvedWorkers = JSON.parse(localStorage.getItem('approvedWorkers') || '[]');
            
            const existsAlready = approvedWorkers.some(name => 
                name.toLowerCase().trim() === newWorkerName.toLowerCase().trim()
            );

            if (existsAlready) {
                showAlert('Worker name already exists in the approved list.', 'warning');
                return;
            }

            approvedWorkers.push(newWorkerName);
            localStorage.setItem('approvedWorkers', JSON.stringify(approvedWorkers));
            localStorage.setItem('lastUpdate', Date.now().toString());
            
            if (serverConnected) {
                const dataToSync = {
                    shiftSubmissions: workerSubmissions,
                    approvedWorkers: approvedWorkers,
                    preferencesLocked: localStorage.getItem('preferencesLocked') === 'true',
                    lockTimestamp: localStorage.getItem('lockTimestamp') || '',
                    lastUpdate: Date.now()
                };
                syncToGitHub(dataToSync);
            }
            
            document.getElementById('newWorkerName').value = '';
            displayApprovedWorkers();
            updateAdminDashboard();
            
            showAlert(`Worker "${newWorkerName}" added successfully! They can now access the worker page.`, 'success');
        }

        function removeWorker(workerName) {
            if (confirm(`Are you sure you want to remove "${workerName}" from the approved workers list?`)) {
                let approvedWorkers = JSON.parse(localStorage.getItem('approvedWorkers') || '[]');
                
                approvedWorkers = approvedWorkers.filter(name => name !== workerName);
                localStorage.setItem('approvedWorkers', JSON.stringify(approvedWorkers));
                localStorage.setItem('lastUpdate', Date.now().toString());
                
                if (serverConnected) {
                    const dataToSync = {
                        shiftSubmissions: workerSubmissions,
                        approvedWorkers: approvedWorkers,
                        preferencesLocked: localStorage.getItem('preferencesLocked') === 'true',
                        lockTimestamp: localStorage.getItem('lockTimestamp') || '',
                        lastUpdate: Date.now()
                    };
                    syncToGitHub(dataToSync);
                }
                
                displayApprovedWorkers();
                updateAdminDashboard();
                
                showAlert(`Worker "${workerName}" removed successfully! They can no longer access the worker page.`, 'success');
            }
        }

        function testWorkerAccess() {
            const testName = document.getElementById('testWorkerName').value.trim();
            const resultDiv = document.getElementById('testResult');
            
            if (!testName) {
                resultDiv.innerHTML = '<div style="color: red; font-size: 12px;">Please enter a name to test.</div>';
                return;
            }

            const approvedWorkers = JSON.parse(localStorage.getItem('approvedWorkers') || '[]');
            const isApproved = approvedWorkers.some(name => 
                name.toLowerCase().trim() === testName.toLowerCase().trim()
            );

            if (isApproved) {
                resultDiv.innerHTML = `<div style="color: green; font-size: 12px;">âœ… "${testName}" would be GRANTED access to the worker page.</div>`;
            } else {
                resultDiv.innerHTML = `<div style="color: red; font-size: 12px;">âŒ "${testName}" would be DENIED access to the worker page.</div>`;
            }
        }

        function displayWorkerSubmissions() {
            const container = document.getElementById('workerSubmissions');
            
            if (workerSubmissions.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No worker submissions yet. Share the worker link to collect preferences.</div>';
                return;
            }

            let html = '';
            workerSubmissions.forEach(submission => {
                const availableShifts = Object.values(submission.preferences)
                    .reduce((count, day) => count + (day.morning ? 1 : 0) + (day.evening ? 1 : 0) + (day.night ? 1 : 0), 0);

                html += `
                    <div class="worker-card ${submission.approved ? 'approved' : ''}">
                        <h3>${submission.name} ${submission.approved ? 'âœ… Approved' : 'â³ Pending'}</h3>
                        <p><strong>Available Shifts:</strong> ${availableShifts}/42 total</p>
                        <p><strong>Submitted:</strong> ${new Date(submission.submittedAt).toLocaleString()}</p>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn ${submission.approved ? 'btn-secondary' : 'btn-success'}" 
                                    onclick="toggleApproval(${submission.id})">
                                ${submission.approved ? 'âœ“ Approved' : 'Approve'}
                            </button>
                            <button class="btn btn-danger" onclick="removeSubmission(${submission.id})">Remove</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleApproval(submissionId) {
            const submission = workerSubmissions.find(s => s.id === submissionId);
            if (submission) {
                submission.approved = !submission.approved;
                saveSubmissions();
                updateAdminDashboard();
                showAlert(`${submission.name} ${submission.approved ? 'approved' : 'unapproved'} successfully!`, 'success');
            }
        }

        function removeSubmission(submissionId) {
            const submission = workerSubmissions.find(s => s.id === submissionId);
            if (submission && confirm(`Are you sure you want to remove ${submission.name}'s submission?`)) {
                workerSubmissions = workerSubmissions.filter(s => s.id !== submissionId);
                saveSubmissions();
                updateAdminDashboard();
                showAlert('Submission removed successfully!', 'success');
            }
        }

        // Schedule generation functions with comprehensive rules
        function generateSchedule() {
            console.log('ğŸ”„ Starting schedule generation...');
            
            const approvedSubmissions = workerSubmissions.filter(s => s.approved);
            
            if (approvedSubmissions.length === 0) {
                showAlert('âŒ No approved worker submissions found. Please approve some submissions first.', 'warning');
                return;
            }

            if (approvedSubmissions.length < 3) {
                showAlert('Warning: Less than 3 approved workers. Schedule may have many unassigned shifts.', 'warning');
            }

            // Lock preferences during generation
            if (localStorage.getItem('preferencesLocked') !== 'true') {
                showAlert('ğŸ”’ Locking preferences during schedule generation...', 'info');
                togglePreferenceLock();
            }

            try {
                showAlert('ğŸ”„ Generating optimized schedule with Hebrew format...', 'info');
                
                // Calculate total possible generations (simplified estimation)
                if (totalPossibleGenerations === 0) {
                    const workers = approvedSubmissions.length;
                    const totalShifts = 42; // 14 days Ã— 3 shifts
                    totalPossibleGenerations = Math.min(10000, Math.pow(workers, Math.min(8, workers)));
                }
                
                currentGeneration++;
                const schedule = generateOptimizedScheduleWithRules(approvedSubmissions);
                
                if (schedule) {
                    generatedScheduleData = schedule;
                    displayGeneratedScheduleHebrew(schedule);
                    
                    // Update generation counter
                    const counterDiv = document.getElementById('generationCounter');
                    counterDiv.innerHTML = `
                        <div style="background: #e9ecef; padding: 8px 15px; border-radius: 5px; display: inline-block;">
                            <strong>Generation ${currentGeneration.toLocaleString()}</strong> of 
                            <span style="color: #007bff;">~${totalPossibleGenerations.toLocaleString()}</span> possible variations
                            <br><small style="color: #6c757d;">Each generation creates a unique schedule combination</small>
                        </div>
                    `;
                    
                    showAlert(`âœ… Schedule generated successfully! Coverage and Hebrew tables ready for export.`, 'success');
                } else {
                    showAlert('âŒ Failed to generate schedule. Please check worker availability.', 'danger');
                }
            } catch (error) {
                console.error('Schedule generation error:', error);
                showAlert('âŒ Error generating schedule: ' + error.message, 'danger');
            }
        }

        function generateOptimizedScheduleWithRules(approvedSubmissions) {
            console.log('ğŸ“Š Generating rule-based schedule for', approvedSubmissions.length, 'approved workers');
            
            // Initialize schedule structure
            const schedule = {};
            const workers = approvedSubmissions.map(s => s.name);
            
            // Track shifts per worker with all rules
            const nightShiftCount = {};
            const weekendShiftCount = {};
            const totalShiftCount = {};
            const nightShiftsWeek1 = {}; // Track night shifts per week (days 0-6)
            const nightShiftsWeek2 = {}; // Track night shifts per week (days 7-13)
            const shiftsWeek1 = {}; // Track ALL shifts per week (days 0-6)
            const shiftsWeek2 = {}; // Track ALL shifts per week (days 7-13)
            const morningShiftsWeek1 = {}; // Track morning shifts per week (days 0-6)
            const morningShiftsWeek2 = {}; // Track morning shifts per week (days 7-13)
            const assignedWorkers = {}; // Track who is assigned to which shifts
            
            workers.forEach(worker => {
                nightShiftCount[worker] = 0;
                weekendShiftCount[worker] = 0;
                totalShiftCount[worker] = 0;
                nightShiftsWeek1[worker] = 0;
                nightShiftsWeek2[worker] = 0;
                shiftsWeek1[worker] = 0;
                shiftsWeek2[worker] = 0;
                morningShiftsWeek1[worker] = 0;
                morningShiftsWeek2[worker] = 0;
            });

            // Generate schedule for 14 days
            for (let day = 0; day < 14; day++) {
                schedule[day] = {
                    morning: null,
                    evening: null,
                    night: null,
                    isWeekendPremium: false
                };
                
                assignedWorkers[day] = new Set(); // Track workers assigned on this day

                // Check if this day has premium shifts (Friday evening to Saturday evening)
                const isPremiumDay = (day === 5) || (day === 6) || (day === 12) || (day === 13);
                if (isPremiumDay) {
                    schedule[day].isWeekendPremium = true;
                }

                // Randomize shift processing order for variety
                const shiftOrder = ['morning', 'evening', 'night'];
                shuffleArray(shiftOrder);
                
                shiftOrder.forEach(shift => {
                    // Check if this specific shift is premium
                    const isPremiumShift = (day === 5 && shift === 'evening') || // Friday evening
                                          (day === 6) ||                        // Saturday all day
                                          (day === 12 && shift === 'evening') || // Friday evening week 2
                                          (day === 13);                         // Saturday all day week 2

                    // Get available workers for this shift based on preferences
                    let availableWorkers = approvedSubmissions
                        .filter(submission => submission.preferences[day] && submission.preferences[day][shift])
                        .map(submission => submission.name);

                    // Apply all scheduling rules
                    availableWorkers = applySchedulingRules(availableWorkers, day, shift, schedule, assignedWorkers, 
                        nightShiftsWeek1, nightShiftsWeek2, shiftsWeek1, shiftsWeek2, morningShiftsWeek1, morningShiftsWeek2);

                    if (availableWorkers.length === 0) {
                        return; // No eligible workers for this shift
                    }

                    // Select worker using prioritized rules
                    const selectedWorker = selectWorkerByRules(availableWorkers, day, shift, isPremiumShift,
                        nightShiftCount, weekendShiftCount, shiftsWeek1, shiftsWeek2, morningShiftsWeek1, morningShiftsWeek2);

                    if (selectedWorker) {
                        // Assign shift
                        schedule[day][shift] = selectedWorker;
                        
                        // Update all tracking counters
                        updateWorkerCounters(selectedWorker, day, shift, isPremiumShift,
                            nightShiftCount, weekendShiftCount, totalShiftCount, nightShiftsWeek1, nightShiftsWeek2,
                            shiftsWeek1, shiftsWeek2, morningShiftsWeek1, morningShiftsWeek2);
                        
                        assignedWorkers[day].add(selectedWorker);
                    }
                });
            }

            // Add statistics and rule compliance to schedule object
            const scheduleStats = {
                schedule,
                nightShiftCount,
                weekendShiftCount,
                totalShiftCount,
                nightShiftsWeek1,
                nightShiftsWeek2,
                shiftsWeek1,
                shiftsWeek2,
                morningShiftsWeek1,
                morningShiftsWeek2,
                ruleViolations: checkRuleCompliance(schedule, workers, nightShiftsWeek1, nightShiftsWeek2, 
                    shiftsWeek1, shiftsWeek2, morningShiftsWeek1, morningShiftsWeek2)
            };

            console.log('ğŸ“ˆ Schedule generated with rule compliance check');
            return scheduleStats;
        }

        function applySchedulingRules(availableWorkers, day, shift, schedule, assignedWorkers, 
            nightShiftsWeek1, nightShiftsWeek2, shiftsWeek1, shiftsWeek2, morningShiftsWeek1, morningShiftsWeek2) {
            
            // Rule 1: Worker can only work once per day (8-hour gap)
            availableWorkers = availableWorkers.filter(worker => !assignedWorkers[day].has(worker));

            // Rule 2: If worker worked night shift previous day, cannot work morning shift today (8-hour gap)
            if (shift === 'morning' && day > 0) {
                const previousNightWorker = schedule[day - 1].night;
                if (previousNightWorker) {
                    availableWorkers = availableWorkers.filter(worker => worker !== previousNightWorker);
                }
            }

            // Rule 3: Maximum 6 shifts per week
            availableWorkers = availableWorkers.filter(worker => {
                const currentWeek = Math.floor(day / 7);
                const weeklyShifts = currentWeek === 0 ? shiftsWeek1[worker] : shiftsWeek2[worker];
                return weeklyShifts < 6;
            });

            // Rule 4: Maximum 2 night shifts per week
            if (shift === 'night') {
                availableWorkers = availableWorkers.filter(worker => {
                    if (day <= 6) {
                        return nightShiftsWeek1[worker] < 2;
                    } else {
                        return nightShiftsWeek2[worker] < 2;
                    }
                });
            }

            // Rule 5: No consecutive night shifts
            if (shift === 'night' && day > 0) {
                const previousNightWorker = schedule[day - 1].night;
                if (previousNightWorker) {
                    availableWorkers = availableWorkers.filter(worker => worker !== previousNightWorker);
                }
            }

            // Rule 6: Prevent "888" pattern (work-off-work-off-work)
            if (day >= 4) {
                availableWorkers = availableWorkers.filter(worker => {
                    const workedDay0 = schedule[day - 4] && 
                        (schedule[day - 4].morning === worker || schedule[day - 4].evening === worker || schedule[day - 4].night === worker);
                    const workedDay2 = schedule[day - 2] && 
                        (schedule[day - 2].morning === worker || schedule[day - 2].evening === worker || schedule[day - 2].night === worker);
                    
                    // If worker worked on day-4 and day-2, they cannot work today (would create 888)
                    if (workedDay0 && workedDay2) {
                        return false;
                    }
                    return true;
                });
            }

            return availableWorkers;
        }

        function selectWorkerByRules(availableWorkers, day, shift, isPremiumShift,
            nightShiftCount, weekendShiftCount, shiftsWeek1, shiftsWeek2, morningShiftsWeek1, morningShiftsWeek2) {
            
            const currentWeek = Math.floor(day / 7);
            const currentWeekShifts = currentWeek === 0 ? shiftsWeek1 : shiftsWeek2;
            const currentWeekMornings = currentWeek === 0 ? morningShiftsWeek1 : morningShiftsWeek2;

            // Priority 1: Workers needing morning shifts (Rule: min 1 morning per week)
            if (shift === 'morning') {
                const workersNeedingMornings = availableWorkers.filter(w => currentWeekMornings[w] === 0);
                if (workersNeedingMornings.length > 0) {
                    // Among workers needing mornings, pick one with fewest total shifts this week
                    const minShiftsAmongMorningNeedy = Math.min(...workersNeedingMornings.map(w => currentWeekShifts[w]));
                    const candidates = workersNeedingMornings.filter(w => currentWeekShifts[w] === minShiftsAmongMorningNeedy);
                    return getRandomFromArray(candidates);
                }
            }

            // Priority 2: Workers with less than 6 shifts this week (Rule: max 6 per week)
            const workersUnder6 = availableWorkers.filter(w => currentWeekShifts[w] < 6);
            if (workersUnder6.length > 0) {
                // Among workers under 6, prioritize by shift type
                if (shift === 'night') {
                    // For night shifts: balance night distribution
                    const currentWeekNights = currentWeek === 0 ? nightShiftsWeek1 : nightShiftsWeek2;
                    const minNights = Math.min(...workersUnder6.map(w => currentWeekNights[w]));
                    const candidates = workersUnder6.filter(w => currentWeekNights[w] === minNights);
                    return getRandomFromArray(candidates);
                } else if (isPremiumShift) {
                    // For premium shifts: balance weekend distribution
                    const minWeekend = Math.min(...workersUnder6.map(w => weekendShiftCount[w]));
                    const candidates = workersUnder6.filter(w => weekendShiftCount[w] === minWeekend);
                    return getRandomFromArray(candidates);
                } else {
                    // For regular shifts: balance weekly distribution
                    const minWeekly = Math.min(...workersUnder6.map(w => currentWeekShifts[w]));
                    const candidates = workersUnder6.filter(w => currentWeekShifts[w] === minWeekly);
                    return getRandomFromArray(candidates);
                }
            }

            // Fallback: Pick worker with minimum shifts in relevant category
            if (shift === 'night') {
                const minNights = Math.min(...availableWorkers.map(w => nightShiftCount[w]));
                const candidates = availableWorkers.filter(w => nightShiftCount[w] === minNights);
                return getRandomFromArray(candidates);
            } else if (isPremiumShift) {
                const minWeekend = Math.min(...availableWorkers.map(w => weekendShiftCount[w]));
                const candidates = availableWorkers.filter(w => weekendShiftCount[w] === minWeekend);
                return getRandomFromArray(candidates);
            } else {
                const minWeekly = Math.min(...availableWorkers.map(w => currentWeekShifts[w]));
                const candidates = availableWorkers.filter(w => currentWeekShifts[w] === minWeekly);
                return getRandomFromArray(candidates);
            }
        }

        function updateWorkerCounters(selectedWorker, day, shift, isPremiumShift,
            nightShiftCount, weekendShiftCount, totalShiftCount, nightShiftsWeek1, nightShiftsWeek2,
            shiftsWeek1, shiftsWeek2, morningShiftsWeek1, morningShiftsWeek2) {
            
            totalShiftCount[selectedWorker]++;
            
            // Update weekly counters
            if (day <= 6) {
                shiftsWeek1[selectedWorker]++;
                if (shift === 'morning') morningShiftsWeek1[selectedWorker]++;
                if (shift === 'night') nightShiftsWeek1[selectedWorker]++;
            } else {
                shiftsWeek2[selectedWorker]++;
                if (shift === 'morning') morningShiftsWeek2[selectedWorker]++;
                if (shift === 'night') nightShiftsWeek2[selectedWorker]++;
            }
            
            // Update night and weekend counters
            if (shift === 'night') {
                nightShiftCount[selectedWorker]++;
            }
            
            if (isPremiumShift) {
                weekendShiftCount[selectedWorker]++;
            }
        }

        function checkRuleCompliance(schedule, workers, nightShiftsWeek1, nightShiftsWeek2, 
            shiftsWeek1, shiftsWeek2, morningShiftsWeek1, morningShiftsWeek2) {
            
            const violations = [];

            workers.forEach(worker => {
                // Check Rule: Max 6 shifts per week
                if (shiftsWeek1[worker] > 6) {
                    violations.push(`${worker}: ${shiftsWeek1[worker]} shifts in week 1 (max 6)`);
                }
                if (shiftsWeek2[worker] > 6) {
                    violations.push(`${worker}: ${shiftsWeek2[worker]} shifts in week 2 (max 6)`);
                }
                
                // Check Rule: Min 1 morning per week (if worker has any shifts that week)
                if (shiftsWeek1[worker] > 0 && morningShiftsWeek1[worker] === 0) {
                    violations.push(`${worker}: No morning shifts in week 1`);
                }
                if (shiftsWeek2[worker] > 0 && morningShiftsWeek2[worker] === 0) {
                    violations.push(`${worker}: No morning shifts in week 2`);
                }
                
                // Check Rule: Max 2 night shifts per week
                if (nightShiftsWeek1[worker] > 2) {
                    violations.push(`${worker}: ${nightShiftsWeek1[worker]} night shifts in week 1 (max 2)`);
                }
                if (nightShiftsWeek2[worker] > 2) {
                    violations.push(`${worker}: ${nightShiftsWeek2[worker]} night shifts in week 2 (max 2)`);
                }
            });

            // Check Rule: 8-hour gap (no consecutive night-morning)
            for (let day = 1; day < 14; day++) {
                const currentMorning = schedule[day].morning;
                const previousNight = schedule[day - 1].night;
                if (currentMorning && previousNight && currentMorning === previousNight) {
                    violations.push(`${currentMorning}: 8-hour gap violation (night day ${day} â†’ morning day ${day + 1})`);
                }
            }

            // Check Rule: No consecutive night shifts
            for (let day = 1; day < 14; day++) {
                const currentNight = schedule[day].night;
                const previousNight = schedule[day - 1].night;
                if (currentNight && previousNight && currentNight === previousNight) {
                    violations.push(`${currentNight}: Consecutive night shifts (days ${day} and ${day + 1})`);
                }
            }

            return violations;
        }

        // Helper functions
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getRandomFromArray(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function displayGeneratedScheduleHebrew(scheduleData) {
            const container = document.getElementById('generatedSchedule');
            
            // Generate unique colors for each worker
            const workerColors = generateWorkerColors(scheduleData);
            
            // Rule compliance summary
            let ruleComplianceClass = scheduleData.ruleViolations.length === 0 ? 'success' : 'warning';
            let ruleComplianceIcon = scheduleData.ruleViolations.length === 0 ? 'âœ…' : 'âš ï¸';
            
            let html = `
                <div class="hebrew-schedule">
                    <!-- Rule Compliance Summary -->
                    <div style="background: ${scheduleData.ruleViolations.length === 0 ? '#d4edda' : '#fff3cd'}; border: 1px solid ${scheduleData.ruleViolations.length === 0 ? '#c3e6cb' : '#ffeaa7'}; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h4>${ruleComplianceIcon} Rule Compliance Status</h4>
                        ${scheduleData.ruleViolations.length === 0 ? 
                            '<div style="color: #155724;"><strong>âœ… All scheduling rules followed perfectly!</strong></div>' :
                            `<div style="color: #856404;"><strong>âš ï¸ ${scheduleData.ruleViolations.length} rule violations detected:</strong><ul style="margin: 10px 0 0 20px;">${scheduleData.ruleViolations.map(v => `<li>${v}</li>`).join('')}</ul></div>`
                        }
                        <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                            <strong>Applied Rules:</strong> 1) 8-hour gap between shifts | 2) Max 6 shifts/week | 3) Min 1 morning/week | 4) Fair premium distribution
                        </div>
                    </div>

                    <!-- Worker Color Legend -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <h4 style="text-align: center; margin-bottom: 10px;">ğŸ‘¥ ×¢×•×‘×“×™× - Worker Legend</h4>
                        <div class="worker-legend">
            `;

            // Add worker colors to legend
            Object.entries(workerColors).forEach(([worker, color]) => {
                html += `<div class="worker-color" style="background-color: ${color};">${worker}</div>`;
            });

            html += `
                        </div>
                    </div>

                    <!-- Week 1 Table -->
                    <div class="schedule-week">
                        <div class="week-header">×©×‘×•×¢ ×¨××©×•×Ÿ: 1-7 ×™×•× ×™ 2025 (Week 1: June 1-7, 2025)</div>
                        <table class="hebrew-table">
                            <thead>
                                <tr>
                                    <th class="shift-label"></th>
                                    <th class="weekend-cell">07.06.25</th>
                                    <th class="premium-shift">06.06.25</th>
                                    <th class="weekday-cell">05.06.25</th>
                                    <th class="weekday-cell">04.06.25</th>
                                    <th class="weekday-cell">03.06.25</th>
                                    <th class="weekday-cell">02.06.25</th>
                                    <th class="weekday-cell">01.06.25</th>
                                </tr>
                                <tr>
                                    <th class="shift-label"></th>
                                    <th class="weekend-cell">×©×‘×ª</th>
                                    <th class="premium-shift">×©×™×©×™</th>
                                    <th class="weekday-cell">×—××™×©×™</th>
                                    <th class="weekday-cell">×¨×‘×™×¢×™</th>
                                    <th class="weekday-cell">×©×œ×™×©×™</th>
                                    <th class="weekday-cell">×©× ×™</th>
                                    <th class="weekday-cell">×¨××©×•×Ÿ</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Week 1 shift rows
            const hebrewShifts = [
                { name: '×‘×§×¨', nameEn: '07-15', key: 'morning' },
                { name: '×¢×¨×‘', nameEn: '15-23', key: 'evening' },
                { name: '×œ×™×œ×”', nameEn: '23-07', key: 'night' }
            ];

            hebrewShifts.forEach(shift => {
                html += `<tr><td class="shift-label">${shift.name}<br><small>${shift.nameEn}</small></td>`;
                
                for (let day = 6; day >= 0; day--) { // Right to left: Saturday to Sunday
                    const worker = scheduleData.schedule[day][shift.key];
                    const isPremium = scheduleData.schedule[day].isWeekendPremium && 
                        ((day === 5 && shift.key === 'evening') || (day === 6));
                    
                    let cellClass = 'assigned-shift';
                    let cellStyle = '';
                    
                    if (worker) {
                        cellStyle = `background-color: ${workerColors[worker]};`;
                        const premiumIcon = isPremium ? ' ğŸ’°' : '';
                        html += `<td class="${cellClass}" style="${cellStyle}">${worker}${premiumIcon}</td>`;
                    } else {
                        html += `<td class="unassigned-shift">×œ× ×××•×™×©</td>`;
                    }
                }
                html += '</tr>';
            });

            html += `
                            </tbody>
                        </table>
                    </div>

                    <!-- Week 2 Table -->
                    <div class="schedule-week">
                        <div class="week-header">×©×‘×•×¢ ×©× ×™: 8-14 ×™×•× ×™ 2025 (Week 2: June 8-14, 2025)</div>
                        <table class="hebrew-table">
                            <thead>
                                <tr>
                                    <th class="shift-label"></th>
                                    <th class="weekend-cell">14.06.25</th>
                                    <th class="premium-shift">13.06.25</th>
                                    <th class="weekday-cell">12.06.25</th>
                                    <th class="weekday-cell">11.06.25</th>
                                    <th class="weekday-cell">10.06.25</th>
                                    <th class="weekday-cell">09.06.25</th>
                                    <th class="weekday-cell">08.06.25</th>
                                </tr>
                                <tr>
                                    <th class="shift-label"></th>
                                    <th class="weekend-cell">×©×‘×ª</th>
                                    <th class="premium-shift">×©×™×©×™</th>
                                    <th class="weekday-cell">×—××™×©×™</th>
                                    <th class="weekday-cell">×¨×‘×™×¢×™</th>
                                    <th class="weekday-cell">×©×œ×™×©×™</th>
                                    <th class="weekday-cell">×©× ×™</th>
                                    <th class="weekday-cell">×¨××©×•×Ÿ</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Week 2 shift rows
            hebrewShifts.forEach(shift => {
                html += `<tr><td class="shift-label">${shift.name}<br><small>${shift.nameEn}</small></td>`;
                
                for (let day = 13; day >= 7; day--) { // Right to left: Saturday to Sunday
                    const worker = scheduleData.schedule[day][shift.key];
                    const isPremium = scheduleData.schedule[day].isWeekendPremium && 
                        ((day === 12 && shift.key === 'evening') || (day === 13));
                    
                    let cellClass = 'assigned-shift';
                    let cellStyle = '';
                    
                    if (worker) {
                        cellStyle = `background-color: ${workerColors[worker]};`;
                        const premiumIcon = isPremium ? ' ğŸ’°' : '';
                        html += `<td class="${cellClass}" style="${cellStyle}">${worker}${premiumIcon}</td>`;
                    } else {
                        html += `<td class="unassigned-shift">×œ× ×××•×™×©</td>`;
                    }
                }
                html += '</tr>';
            });

            html += `
                            </tbody>
                        </table>
                    </div>

                    <!-- Schedule Statistics -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 20px;">
                        <h4>ğŸ“Š Schedule Statistics & Worker Performance</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
            `;

            // Calculate and display worker statistics
            Object.entries(scheduleData.shiftsWeek1).forEach(([workerName, week1Shifts]) => {
                const week2Shifts = scheduleData.shiftsWeek2[workerName] || 0;
                const week1Mornings = scheduleData.morningShiftsWeek1[workerName] || 0;
                const week2Mornings = scheduleData.morningShiftsWeek2[workerName] || 0;
                const premiumShifts = scheduleData.weekendShiftCount[workerName] || 0;
                const totalShifts = scheduleData.totalShiftCount[workerName] || 0;
                
                // Check rule compliance for this worker
                const hasViolations = 
                    week1Shifts > 6 || week2Shifts > 6 || 
                    (week1Shifts > 0 && week1Mornings === 0) || 
                    (week2Shifts > 0 && week2Mornings === 0);
                
                const cardStyle = hasViolations ? 'border: 2px solid #ffc107; background: #fff3cd;' : 'border: 1px solid #dee2e6; background: white;';
                
                html += `
                    <div style="${cardStyle} padding: 15px; border-radius: 5px;">
                        <h5 style="margin-bottom: 10px; color: #495057;">
                            ${workerName} ${hasViolations ? 'âš ï¸' : 'âœ…'}
                            <span style="background-color: ${workerColors[workerName]}; padding: 2px 8px; border-radius: 3px; margin-right: 5px; border: 1px solid #333;"></span>
                        </h5>
                        <div style="font-size: 12px; line-height: 1.6;">
                            <div><strong>Total Shifts:</strong> ${totalShifts}</div>
                            <div><strong>Week 1:</strong> ${week1Shifts} shifts (${week1Mornings} morning)</div>
                            <div><strong>Week 2:</strong> ${week2Shifts} shifts (${week2Mornings} morning)</div>
                            <div><strong>Premium Shifts:</strong> ${premiumShifts} ğŸ’°</div>
                            ${hasViolations ? 
                                '<div style="color: #856404; margin-top: 8px; font-weight: bold;">âš ï¸ Rule violations detected</div>' : 
                                '<div style="color: #155724; margin-top: 8px; font-weight: bold;">âœ… All rules followed</div>'
                            }
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div style="background: #e7f3ff; border: 1px solid #b8daff; border-radius: 8px; padding: 15px; margin-top: 20px;">
                        <h4>ğŸ“‹ Export Options</h4>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="exportSchedule()" style="margin-right: 10px;">ğŸ“Š Export CSV</button>
                            <button class="btn" onclick="copyExcelFormat()">ğŸ“‹ Copy Hebrew Excel Format</button>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #0c5460;">
                            <strong>ğŸ’¡ Export Tips:</strong><br>
                            â€¢ CSV: Standard format for all spreadsheet programs<br>
                            â€¢ Hebrew Excel: Right-to-left format optimized for Hebrew Excel/Google Sheets<br>
                            â€¢ Both formats include worker colors and premium shift indicators
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function generateWorkerColors(scheduleData) {
            const workers = Object.keys(scheduleData.totalShiftCount);
            const colors = [
                '#FFB3BA', '#FFDFBA', '#FFFFBA', '#BAFFC9', '#BAE1FF', 
                '#C9BAFF', '#FFBAE1', '#FFD4BA', '#BAF2FF', '#E1BAFF',
                '#BAFFE1', '#FFC9BA', '#BAFFFF', '#F2BAFF', '#BAFF9A',
                '#FF9ABA', '#9ABAFF', '#BA9AFF', '#FFBA9A', '#9AFFBA'
            ];
            
            const workerColors = {};
            workers.forEach((worker, index) => {
                workerColors[worker] = colors[index % colors.length];
            });
            
            return workerColors;
        }

        function exportSchedule() {
            if (!generatedScheduleData) {
                showAlert('âŒ No schedule to export. Please generate a schedule first.', 'warning');
                return;
            }

            try {
                let csvContent = 'Date,Day,Morning Shift,Evening Shift,Night Shift,Premium Day,Notes\n';
                
                const startDate = new Date(2025, 5, 1); // June 1st, 2025
                
                for (let day = 0; day < 14; day++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + day);
                    
                    const dateStr = currentDate.toLocaleDateString('en-GB');
                    const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' });
                    const morning = generatedScheduleData.schedule[day].morning || 'Unassigned';
                    const evening = generatedScheduleData.schedule[day].evening || 'Unassigned';
                    const night = generatedScheduleData.schedule[day].night || 'Unassigned';
                    const isPremium = generatedScheduleData.schedule[day].isWeekendPremium ? 'Yes' : 'No';
                    const notes = generatedScheduleData.schedule[day].isWeekendPremium ? 'Premium pay period' : '';
                    
                    csvContent += `${dateStr},${dayName},${morning},${evening},${night},${isPremium},"${notes}"\n`;
                }

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `shift_schedule_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showAlert('âœ… Schedule exported as CSV file!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('âŒ Failed to export schedule: ' + error.message, 'danger');
            }
        }

        function copyExcelFormat() {
            if (!generatedScheduleData) {
                showAlert('âŒ No schedule to copy. Please generate a schedule first.', 'warning');
                return;
            }

            try {
                let excelContent = '';
                
                // Week 1 Header
                excelContent += '×©×‘×•×¢ ×¨××©×•×Ÿ (Week 1)\n\n';
                
                // Week 1 dates header
                excelContent += '\t07.06.25\t06.06.25\t05.06.25\t04.06.25\t03.06.25\t02.06.25\t01.06.25\n';
                
                // Week 1 Hebrew days header
                excelContent += '\t×©×‘×ª\t×©×™×©×™\t×—××™×©×™\t×¨×‘×™×¢×™\t×©×œ×™×©×™\t×©× ×™\t×¨××©×•×Ÿ\n';
                
                // Week 1 data rows
                const hebrewShifts = [
                    { name: '×‘×§×¨', key: 'morning' },
                    { name: '×¢×¨×‘', key: 'evening' },
                    { name: '×œ×™×œ×”', key: 'night' }
                ];
                
                hebrewShifts.forEach(shift => {
                    excelContent += shift.name;
                    for (let day = 6; day >= 0; day--) { // Right to left
                        const worker = generatedScheduleData.schedule[day][shift.key] || '';
                        excelContent += '\t' + worker;
                    }
                    excelContent += '\n';
                });
                
                excelContent += '\n\n';
                
                // Week 2 Header
                excelContent += '×©×‘×•×¢ ×©× ×™ (Week 2)\n\n';
                
                // Week 2 dates header
                excelContent += '\t14.06.25\t13.06.25\t12.06.25\t11.06.25\t10.06.25\t09.06.25\t08.06.25\n';
                
                // Week 2 Hebrew days header
                excelContent += '\t×©×‘×ª\t×©×™×©×™\t×—××™×©×™\t×¨×‘×™×¢×™\t×©×œ×™×©×™\t×©× ×™\t×¨××©×•×Ÿ\n';
                
                // Week 2 data rows
                hebrewShifts.forEach(shift => {
                    excelContent += shift.name;
                    for (let day = 13; day >= 7; day--) { // Right to left
                        const worker = generatedScheduleData.schedule[day][shift.key] || '';
                        excelContent += '\t' + worker;
                    }
                    excelContent += '\n';
                });

                // Copy to clipboard
                navigator.clipboard.writeText(excelContent).then(() => {
                    showAlert('âœ… Hebrew schedule format copied to clipboard! Ready to paste into Excel.', 'success');
                }).catch(err => {
                    console.error('Clipboard error:', err);
                    showAlert('âŒ Failed to copy to clipboard. Try using the CSV export instead.', 'warning');
                });
            } catch (error) {
                console.error('Copy error:', error);
                showAlert('âŒ Failed to copy schedule: ' + error.message, 'danger');
            }
        }

        function clearAllData() {
            if (confirm('âš ï¸ Are you sure you want to clear ALL data? This will remove all worker submissions, generated schedules, AND approved worker names. This action cannot be undone.')) {
                if (confirm('This is your final warning. ALL data including approved worker names will be permanently deleted. Continue?')) {
                    workerSubmissions = [];
                    generatedScheduleData = null;
                    currentGeneration = 0;
                    totalPossibleGenerations = 0;
                    
                    localStorage.removeItem('approvedWorkers');
                    localStorage.removeItem('preferencesLocked');
                    localStorage.removeItem('lockTimestamp');
                    
                    saveSubmissions();
                    updateAdminDashboard();
                    
                    document.getElementById('generatedSchedule').innerHTML = 
                        '<div class="alert alert-info">No schedule generated yet. Click "Generate Optimized Schedule" to create one.</div>';
                    
                    showAlert('All data has been cleared, including approved worker names.', 'success');
                }
            }
        }

        function showAlert(message, type = 'info') {
            const alertClass = `alert-${type}`;
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.innerHTML = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(alertDiv, content.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Initialize with Enter key support
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const newWorkerInput = document.getElementById('newWorkerName');
                if (newWorkerInput) {
                    newWorkerInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addWorker();
                        }
                    });
                }
            }, 100);
        });

        // Cleanup interval on page unload
        window.addEventListener('beforeunload', function() {
            if (syncIntervalId) {
                clearInterval(syncIntervalId);
            }
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Shift Schedule Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
        }

        .workers-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .worker-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            transition: transform 0.2s ease;
        }

        .worker-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .worker-card h3 {
            color: #495057;
            margin-bottom: 10px;
        }

        .worker-card.approved {
            border-color: #28a745;
            background: #f8fff9;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .admin-actions {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .password-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .password-input {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .password-input input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .lock-control {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .lock-status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .lock-status.locked {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .lock-status.unlocked {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .sync-status {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .sync-status.connected {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .sync-status.disconnected {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .server-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .hidden {
            display: none;
        }

        /* Hebrew Schedule Styles */
        .hebrew-schedule {
            direction: rtl;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .schedule-week {
            background: white;
            margin: 30px 0;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .week-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        
        .hebrew-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .hebrew-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            font-weight: bold;
            color: #495057;
        }
        
        .hebrew-table td {
            padding: 15px 8px;
            border: 1px solid #dee2e6;
            text-align: center;
            vertical-align: middle;
            min-height: 40px;
        }
        
        .shift-label {
            background: #e9ecef;
            font-weight: bold;
            color: #495057;
            text-align: center;
            width: 80px;
        }
        
        .weekday-cell {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .weekend-cell {
            background: #ffebee;
            color: #c62828;
        }
        
        .premium-shift {
            background: #fff3e0;
            border: 2px solid #ff9800;
            font-weight: bold;
        }
        
        .assigned-shift {
            border: 2px solid #4caf50;
            font-weight: bold;
        }
        
        .unassigned-shift {
            background: #fafafa;
            color: #757575;
            font-style: italic;
        }
        
        .worker-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .worker-color {
            padding: 8px 15px;
            border-radius: 5px;
            border: 2px solid #333;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ Admin Dashboard</h1>
            <p>Server-Based Shift Schedule Manager</p>
        </div>

        <div class="content">
            <!-- Simple Password Protection -->
            <div id="passwordSection" class="password-section">
                <h3>ğŸ”’ Admin Access Required</h3>
                <p>Enter the admin password to access the dashboard:</p>
                <div class="password-input">
                    <input type="password" id="adminPassword" placeholder="Enter admin password">
                    <button class="btn" onclick="checkPassword()">Access Dashboard</button>
                </div>
                <small>Default password: admin123 (change this in production!)</small>
            </div>

            <div id="adminContent" class="hidden">
                <!-- Server Connection Status -->
                <div id="serverInfo" class="server-info">
                    <h4>ğŸ–¥ï¸ Server Connection Status</h4>
                    <div id="connectionStatus">
                        ğŸ”„ Testing server connection...
                    </div>
                </div>

                <!-- Sync Status Display -->
                <div id="syncStatusDisplay" class="sync-status">
                    <h4>ğŸ”„ Data Synchronization Status</h4>
                    <div id="syncStatusContent">
                        <div>ğŸ”„ Initializing sync...</div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSubmissions">0</div>
                        <div>Total Submissions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingApprovals">0</div>
                        <div>Pending Approvals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="approvedWorkersCount">0</div>
                        <div>Approved Workers</div>
                    </div>
                </div>

                <!-- Preference Lock Control -->
                <div class="lock-control">
                    <h3>ğŸ”’ Preference Submission Control</h3>
                    <p>Lock worker preferences during schedule generation to prevent changes.</p>
                    
                    <div id="lockStatus" class="lock-status">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn" id="toggleLockBtn" onclick="togglePreferenceLock()">
                            <!-- Text will be set by JavaScript -->
                        </button>
                        <small style="display: block; margin-top: 10px; color: #856404;">
                            <strong>Tip:</strong> Lock preferences before generating schedules to ensure data consistency.
                        </small>
                    </div>
                </div>

                <!-- Admin Actions -->
                <div class="admin-actions">
                    <h3>Quick Actions</h3>
                    <button class="btn btn-secondary" onclick="exportSchedule()">ğŸ“Š Export Schedule (CSV)</button>
                    <button class="btn" onclick="copyExcelFormat()">ğŸ“‹ Copy Excel Format</button>
                    <button class="btn" onclick="refreshData()">ğŸ”„ Refresh Data</button>
                    <button class="btn" onclick="manualSync()" id="syncBtn">ğŸ”„ Sync Now</button>
                    <button class="btn" onclick="testServerConnection()" id="testBtn">ğŸ” Test Connection</button>
                    <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Clear All Data</button>
                    
                    <div id="syncResult" style="margin-top: 10px; font-size: 12px;">
                        <!-- Sync results will be shown here -->
                    </div>
                </div>

                <!-- Worker Access Management -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3>ğŸ‘¥ Worker Access Management</h3>
                    <p>Manage which workers can access the shift preference system.</p>
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px;">
                        <strong>âš ï¸ Important:</strong> Only workers added to this list can submit shift preferences.
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="newWorkerName" placeholder="Enter worker name" style="flex: 1; padding: 8px;">
                            <button class="btn btn-success" onclick="addWorker()">Add Worker</button>
                        </div>
                    </div>

                    <div id="approvedWorkersList">
                        <!-- Will be populated by JavaScript -->
                    </div>

                    <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;">
                        <h5>ğŸ” Test Access Control:</h5>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                            <input type="text" id="testWorkerName" placeholder="Enter name to test" style="flex: 1; padding: 6px;">
                            <button class="btn" onclick="testWorkerAccess()" style="padding: 6px 12px; font-size: 14px;">Test Access</button>
                        </div>
                        <div id="testResult" style="margin-top: 10px;"></div>
                    </div>
                </div>

                <!-- Worker Submissions -->
                <h3>Worker Submissions</h3>
                <div id="workerSubmissions" class="workers-list">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Schedule Generation -->
                <div style="margin: 30px 0; text-align: center;">
                    <button class="btn btn-success" onclick="generateSchedule()" style="font-size: 18px; padding: 15px 40px;">
                        ğŸ”„ Generate Optimized Schedule
                    </button>
                    <div id="generationCounter" style="margin-top: 10px; font-size: 14px; color: #6c757d;">
                        <!-- Will show generation count after first generation -->
                    </div>
                </div>

                <!-- Generated Schedule -->
                <h3>Generated Schedule</h3>
                <div id="generatedSchedule">
                    <div class="alert alert-info">No schedule generated yet. Click "Generate Optimized Schedule" to create one.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let workerSubmissions = [];
        let generatedScheduleData = null;
        let currentGeneration = 0;
        let totalPossibleGenerations = 0;
        const ADMIN_PASSWORD = 'admin123'; // Change this in production!
        
        // Server-based configuration - no tokens needed in frontend!
        const syncEnabled = true; // Server handles authentication
        let lastSyncTime = null;
        let syncIntervalId = null;
        let serverConnected = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Admin Dashboard starting (Server-based)...');
            
            // Password enter key support
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
        });

        async function testServerConnection() {
            const testBtn = document.getElementById('testBtn');
            testBtn.textContent = 'ğŸ”„ Testing...';
            testBtn.disabled = true;
            
            try {
                const response = await fetch('/api/test');
                const result = await response.json();
                
                if (result.success) {
                    updateConnectionStatus(`âœ… Connected as ${result.user}`, 'success');
                    serverConnected = true;
                    showSyncResult('âœ… Server connection successful', 'success');
                } else {
                    updateConnectionStatus('âŒ Server connection failed: ' + result.error, 'error');
                    serverConnected = false;
                    showSyncResult('âŒ Connection failed', 'error');
                }
            } catch (error) {
                updateConnectionStatus('âŒ Cannot reach server: ' + error.message, 'error');
                serverConnected = false;
                showSyncResult('âŒ Server unreachable', 'error');
            } finally {
                testBtn.textContent = 'ğŸ” Test Connection';
                testBtn.disabled = false;
            }
        }

        function updateConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            const colors = {
                success: 'green',
                error: 'red',
                info: 'blue',
                warning: 'orange'
            };
            statusDiv.style.color = colors[type] || 'black';
            statusDiv.innerHTML = message;
        }

        async function initialSync() {
            console.log('ğŸ”„ Starting initial sync...');
            updateSyncStatus('Connecting to server...', 'info');
            
            try {
                // Test server connection first
                await testServerConnection();
                
                if (serverConnected) {
                    const success = await syncFromGitHub();
                    if (success) {
                        console.log('âœ… Initial sync from server successful');
                        updateSyncStatus('Connected to server - Data synchronized', 'success');
                        
                        // Auto-sync every 30 seconds
                        if (syncIntervalId) clearInterval(syncIntervalId);
                        syncIntervalId = setInterval(() => {
                            console.log('â° Auto-sync triggered');
                            syncFromGitHub();
                        }, 30000);
                    } else {
                        console.log('âš ï¸ Server sync failed, loading local data');
                        loadSubmissions();
                        updateSyncStatus('Server sync failed - Using local data', 'warning');
                    }
                } else {
                    loadSubmissions();
                    updateSyncStatus('Server not available - Using local data', 'warning');
                }
            } catch (error) {
                console.error('âŒ Initial sync error:', error);
                loadSubmissions();
                updateSyncStatus('Sync error - Using local data only', 'error');
            }
        }

        // Updated sync functions for server-based approach
        async function syncToGitHub(data) {
            if (!serverConnected) {
                console.log('âŒ Server not connected');
                return false;
            }
            
            try {
                console.log('ğŸ“¤ Syncing data to server...');
                
                const response = await fetch('/api/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… Data synced to server successfully');
                    lastSyncTime = Date.now();
                    localStorage.setItem('lastSyncTime', lastSyncTime.toString());
                    updateSyncStatus('Last sync: ' + new Date().toLocaleTimeString(), 'success');
                    showSyncResult('âœ… Synced to server', 'success');
                    return true;
                } else {
                    console.error('âŒ Failed to sync to server:', result.error);
                    updateSyncStatus('Upload failed: ' + result.error, 'error');
                    showSyncResult('âŒ Upload failed', 'error');
                    return false;
                }
            } catch (error) {
                console.error('âŒ Sync to server error:', error);
                updateSyncStatus('Upload error: ' + error.message, 'error');
                showSyncResult('âŒ Upload error', 'error');
                return false;
            }
        }

        async function syncFromGitHub() {
            if (!serverConnected) {
                console.log('âŒ Server not connected');
                return false;
            }
            
            try {
                console.log('ğŸ“¥ Syncing from server...');
                
                const response = await fetch('/api/data');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    console.log('ğŸ“¦ Server data received:', Object.keys(data));
                    
                    workerSubmissions = data.shiftSubmissions || [];
                    localStorage.setItem('shiftSubmissions', JSON.stringify(workerSubmissions));
                    localStorage.setItem('approvedWorkers', JSON.stringify(data.approvedWorkers || []));
                    localStorage.setItem('preferencesLocked', data.preferencesLocked ? 'true' : 'false');
                    localStorage.setItem('lockTimestamp', data.lockTimestamp || '');
                    localStorage.setItem('lastUpdate', (data.lastUpdate || Date.now()).toString());
                    
                    lastSyncTime = Date.now();
                    localStorage.setItem('lastSyncTime', lastSyncTime.toString());
                    
                    console.log('âœ… Data updated from server');
                    updateSyncStatus('Last sync: ' + new Date().toLocaleTimeString(), 'success');
                    
                    if (!document.getElementById('adminContent').classList.contains('hidden')) {
                        updateAdminDashboard();
                    }
                    
                    return true;
                } else {
                    console.error('âŒ Server API error:', result.error);
                    updateSyncStatus('Download failed: ' + result.error, 'error');
                    return false;
                }
            } catch (error) {
                console.error('âŒ Failed to sync from server:', error);
                updateSyncStatus('Download error: ' + error.message, 'error');
                return false;
            }
        }

        function updateSyncStatus(message, type) {
            const statusDiv = document.getElementById('syncStatusDisplay');
            const contentDiv = document.getElementById('syncStatusContent');
            
            let statusClass = 'sync-status';
            let icon = 'ğŸ”„';
            
            switch(type) {
                case 'success':
                    statusClass += ' connected';
                    icon = 'âœ…';
                    break;
                case 'error':
                    statusClass += ' disconnected';
                    icon = 'âŒ';
                    break;
                case 'warning':
                    statusClass += ' disconnected';
                    icon = 'âš ï¸';
                    break;
                default:
                    icon = 'ğŸ”„';
            }
            
            statusDiv.className = statusClass;
            
            const timeStr = new Date().toLocaleTimeString();
            contentDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${icon} ${message}</span>
                    <small>${timeStr}</small>
                </div>
                <div style="margin-top: 5px; font-size: 12px; opacity: 0.8;">
                    Server-based sync | Auto-sync every 30s
                </div>
            `;
        }

        function showSyncResult(message, type) {
            const resultDiv = document.getElementById('syncResult');
            const className = type === 'success' ? 'color: green' : 'color: red';
            resultDiv.innerHTML = `<div style="${className}; font-weight: bold;">${message}</div>`;
            
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 3000);
        }

        function checkPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                document.getElementById('passwordSection').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                
                // Initialize everything after login
                initialSync();
                updateAdminDashboard();
            } else {
                alert('Incorrect password. Please try again.');
                document.getElementById('adminPassword').value = '';
            }
        }

        function loadSubmissions() {
            const stored = localStorage.getItem('shiftSubmissions');
            workerSubmissions = stored ? JSON.parse(stored) : [];
            console.log('ğŸ“ Loaded submissions from localStorage:', workerSubmissions.length);
        }

        function saveSubmissions() {
            localStorage.setItem('shiftSubmissions', JSON.stringify(workerSubmissions));
            localStorage.setItem('lastUpdate', Date.now().toString());
            
            if (serverConnected) {
                // Create the data object to sync
                const dataToSync = {
                    shiftSubmissions: workerSubmissions,
                    approvedWorkers: JSON.parse(localStorage.getItem('approvedWorkers') || '[]'),
                    preferencesLocked: localStorage.getItem('preferencesLocked') === 'true',
                    lockTimestamp: localStorage.getItem('lockTimestamp') || '',
                    lastUpdate: Date.now()
                };
                syncToGitHub(dataToSync);
            }
        }

        function refreshData() {
            if (serverConnected) {
                syncFromGitHub().then(() => {
                    updateAdminDashboard();
                    showAlert('Data refreshed from server!', 'success');
                });
            } else {
                loadSubmissions();
                updateAdminDashboard();
                showAlert('Data refreshed from local storage!', 'success');
            }
        }

        async function manualSync() {
            if (!serverConnected) {
                showAlert('Server is not connected. Please test connection first.', 'warning');
                return;
            }
            
            const syncBtn = document.getElementById('syncBtn');
            syncBtn.textContent = 'ğŸ”„ Syncing...';
            syncBtn.disabled = true;
            
            try {
                updateSyncStatus('Manual sync in progress...', 'info');
                
                const downloadSuccess = await syncFromGitHub();
                
                // Create data to upload
                const dataToSync = {
                    shiftSubmissions: workerSubmissions,
                    approvedWorkers: JSON.parse(localStorage.getItem('approvedWorkers') || '[]'),
                    preferencesLocked: localStorage.getItem('preferencesLocked') === 'true',
                    lockTimestamp: localStorage.getItem('lockTimestamp') || '',
                    lastUpdate: Date.now()
                };
                
                const uploadSuccess = await syncToGitHub(dataToSync);
                
                if (downloadSuccess && uploadSuccess) {
                    showAlert('âœ… Manual sync completed successfully!', 'success');
                    updateSyncStatus('Manual sync completed', 'success');
                } else if (uploadSuccess) {
                    showAlert('âš ï¸ Upload successful, download had issues', 'warning');
                } else if (downloadSuccess) {
                    showAlert('âš ï¸ Download successful, upload had issues', 'warning');
                } else {
                    showAlert('âŒ Manual sync failed', 'danger');
                }
                
                updateAdminDashboard();
            } catch (error) {
                showAlert('âŒ Sync error: ' + error.message, 'danger');
                console.error('Manual sync error:', error);
            } finally {
                syncBtn.textContent = 'ğŸ”„ Sync Now';
                syncBtn.disabled = false;
            }
        }

        function updateAdminDashboard() {
            document.getElementById('totalSubmissions').textContent = workerSubmissions.length;
            document.getElementById('pendingApprovals').textContent = 
                workerSubmissions.filter(s => !s.approved).length;
            
            const approvedWorkers = JSON.parse(localStorage.getItem('approvedWorkers') || '[]');
            document.getElementById('approvedWorkersCount').textContent = approvedWorkers.length;

            displayWorkerSubmissions();
            displayApprovedWorkers();
            updateLockStatus();
        }

        function togglePreferenceLock() {
            const isCurrentlyLocked = localStorage.getItem('preferencesLocked') === 'true';
            const newLockState = !isCurrentlyLocked;
            
            localStorage.setItem('preferencesLocked', newLockState.toString());
            localStorage.setItem('lockTimestamp', Date.now().toString());
            localStorage.setItem('lockSetBy', 'admin');
            localStorage.setItem('lastUpdate', Date.now().toString());
            
            updateLockStatus();
            
            if (serverConnected) {
                const dataToSync = {
                    shiftSubmissions: workerSubmissions,
                    approvedWorkers: JSON.parse(localStorage.getItem('approvedWorkers') || '[]'),
